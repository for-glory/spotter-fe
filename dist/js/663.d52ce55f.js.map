{"version":3,"file":"js/663.d52ce55f.js","mappings":"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","sources":["webpack://spotter/./src/general/views/profile/ChoosePaymentMethod.vue?3304","webpack://spotter/./src/general/views/profile/ChoosePaymentMethod.vue"],"sourcesContent":["import { defineComponent as _defineComponent } from 'vue'\nimport { createVNode as _createVNode, unref as _unref, openBlock as _openBlock, createBlock as _createBlock, createCommentVNode as _createCommentVNode, createTextVNode as _createTextVNode, withCtx as _withCtx, renderList as _renderList, Fragment as _Fragment, createElementBlock as _createElementBlock, toDisplayString as _toDisplayString } from \"vue\"\n\nconst _hoisted_1 = {\n  key: 1,\n  class: \"cards\"\n}\nconst _hoisted_2 = {\n  key: 0,\n  class: \"cards__container\"\n}\n\nimport BaseLayout from \"@/general/components/base/BaseLayout.vue\";\nimport PageHeader from \"@/general/components/blocks/headers/PageHeader.vue\";\nimport CardForm from \"@/general/components/forms/CardForm.vue\";\nimport {\n  IonText,\n  IonButton,\n  IonTitle,\n  IonIcon,\n  IonNote,\n  toastController,\n  IonSpinner,\n} from \"@ionic/vue\";\nimport PaymentMethod from \"@/general/components/blocks/payment/PaymentMethod.vue\";\nimport { computed, onMounted, onUnmounted, ref } from \"vue\";\nimport Card from \"@/general/components/blocks/payment/Card.vue\";\nimport BaseCarousel from \"@/general/components/base/BaseCarousel.vue\";\nimport { useRouter, useRoute } from \"vue-router\";\nimport { BackendStripe } from \"@/services/stripe/stripe\";\nimport { Cards } from \"@/services/stripe/cards\";\nimport AddCardButton from \"@/general/components/blocks/payment/AddCardButton.vue\";\nimport {\n  Stripe as capacitorStripe,\n  ApplePayEventsEnum,\n  GooglePayEventsEnum,\n} from \"@capacitor-community/stripe\";\nimport { PaymentProvidersEnum, MeDocument } from \"@/generated/graphql\";\nimport { useQuery, useLazyQuery } from \"@vue/apollo-composable\";\nimport { navigationAfterPaymentCompleted } from \"@/helpers/purchaseRouterNavigation\";\nimport debounce from \"lodash/debounce\";\nimport { setAuthItems } from \"@/router/middleware/auth\";\nimport useSubscription from \"@/hooks/useSubscription\";\n\n\nexport default /*#__PURE__*/_defineComponent({\n  __name: 'ChoosePaymentMethod',\n  setup(__props) {\n\nconst VUE_APP_STRIPE_PUBLIC_KEY = process.env.VUE_APP_STRIPE_PUBLIC_KEY;\nconst cardCreation = ref(false);\nconst preparedCards = ref<typeof Card[]>([]);\nconst errorMessage = ref(\"\");\nconst router = useRouter();\nconst route = useRoute();\nconst cardsContainer = new Cards();\nconst interval = ref(null);\n\nconst backendStripe = new BackendStripe(VUE_APP_STRIPE_PUBLIC_KEY || \"\");\n\nonUnmounted(() => {\n  clearInterval(interval.value);\n});\n\nconst {\n  loading,\n  load: getMyProfile,\n  onResult: gotMyProfile,\n} = useLazyQuery(MeDocument, {\n  fetchPolicy: \"no-cache\",\n});\ngetMyProfile();\n\nconst { type: currentSubscriptionType } = useSubscription();\ngotMyProfile(({ data }) => {\n  if (data.me.currentSubscription !== currentSubscriptionType) {\n    setAuthItems(data.me);\n    onBack();\n  }\n});\n\nonMounted(() => {\n  refetch();\n\n  backendStripe.init();\n\n  capacitorStripe\n    .initialize({\n      publishableKey: VUE_APP_STRIPE_PUBLIC_KEY,\n    })\n\n  interval.value = setInterval(() => {\n    refetch();\n  }, 5000);\n});\n\nconst { mutate: changeCard } = backendStripe.changePaymentMethod();\nconst { mutate: createSubscriptionIntent } = backendStripe.createSubscriptionIntent();\nconst { onResult: cardsResult, refetch } = backendStripe.getCards();\n\n// temporary solution for updating new cards\nconst getCards = debounce(() => {\n  refetch();\n}, 5000);\n\ngetCards();\n\nconst onSubmit = () => {\n  errorMessage.value = \"\";\n\n  createSubscriptionIntent({\n    product_id: route.params.subscriptionId,\n    facility_id: route.query.facilityId,\n  })\n    .then((data) => {\n      console.log(\"data==>\", data)\n      let intent = JSON.parse(data?.data?.createSubscriptionIntent?.session);\n      backendStripe.redirectToCheckout(intent.id);\n    })\n    .catch((err) => {\n      errorMessage.value = err;\n      throw new Error(err);\n    });\n\n  if (cardCreation.value) {\n    cardCreation.value = !cardCreation.value;\n  } else {\n    // TODO need find solution how to transit user to Payment Success page\n  }\n};\n\ncardsResult((response) => {\n  cardsContainer.init(response?.data?.cards?.data || []);\n  preparedCards.value = cardsContainer.cards;\n});\n\nconst changePaymentMethod = (cardId: number) => {\n  changeCard({ card_id: cardId })\n    .then(() => {\n      preparedCards.value.forEach((element: typeof Card) => {\n        element.is_default = element.id === cardId;\n      });\n    })\n    .catch((err) => {\n      errorMessage.value = err;\n      throw new Error(err);\n    });\n};\n\nconst onCardCreation = async () => {\n  const { onResult } = backendStripe.createSetupIntent();\n  onResult((setupIntentResult) => {\n    let intent = JSON.parse(setupIntentResult?.data?.setupIntent?.session);\n    backendStripe.redirectToCardSaving(intent.id, intent.url);\n  });\n};\n\nconst onBack = () => {\n  router.go(-1);\n};\n\ncapacitorStripe.addListener(ApplePayEventsEnum.Completed, () => {\n  // navigationAfterPaymentCompleted(\n  //   route.params.orderId,\n  //   route.query.cart_id as string\n  // );\n});\n\ncapacitorStripe.addListener(ApplePayEventsEnum.Failed, () => {\n  errorMessage.value = \"Something went wrong, please try again\";\n  // @TODO create correct behaviour of failed payment\n});\n\ncapacitorStripe.addListener(GooglePayEventsEnum.Completed, () => {\n  // navigationAfterPaymentCompleted(\n  //   route.params.orderId,\n  //   route.query.cart_id as string\n  // );\n  // @TODO create correct behaviour of completed payment\n});\n\ncapacitorStripe.addListener(GooglePayEventsEnum.Failed, () => {\n  errorMessage.value = \"Something went wrong, please try again\";\n  // @TODO create correct behaviour of failed payment\n});\n\n\nreturn (_ctx: any,_cache: any) => {\n  return (_openBlock(), _createBlock(BaseLayout, { \"full-width-footer\": false }, {\n    header: _withCtx(() => [\n      _createVNode(PageHeader, {\n        \"back-btn\": \"\",\n        onBack: onBack,\n        title: \"Payment\"\n      })\n    ]),\n    content: _withCtx(() => [\n      (_unref(loading))\n        ? (_openBlock(), _createBlock(_unref(IonSpinner), {\n            key: 0,\n            class: \"spinner\",\n            name: \"lines\"\n          }))\n        : (_openBlock(), _createElementBlock(_Fragment, { key: 1 }, [\n            (cardCreation.value)\n              ? (_openBlock(), _createBlock(CardForm, { key: 0 }))\n              : (_openBlock(), _createElementBlock(\"div\", _hoisted_1, [\n                  _createVNode(_unref(IonTitle), { class: \"cards__title\" }, {\n                    default: _withCtx(() => [\n                      _createTextVNode(\"Payment Method\")\n                    ]),\n                    _: 1\n                  }),\n                  (preparedCards.value?.length)\n                    ? (_openBlock(), _createElementBlock(\"div\", _hoisted_2, [\n                        _createVNode(BaseCarousel, {\n                          \"show-start\": \"\",\n                          items: preparedCards.value,\n                          \"slides-offset-after\": 16,\n                          \"slides-offset-before\": 16\n                        }, {\n                          start: _withCtx(() => [\n                            _createVNode(_unref(IonButton), {\n                              onClick: onCardCreation,\n                              class: \"add-card\"\n                            }, {\n                              default: _withCtx(() => [\n                                _createVNode(_unref(IonIcon), {\n                                  src: \"assets/icon/payment/plus.svg\",\n                                  class: \"add-icon\"\n                                })\n                              ]),\n                              _: 1\n                            })\n                          ]),\n                          default: _withCtx((preparedCards) => [\n                            (_openBlock(true), _createElementBlock(_Fragment, null, _renderList(preparedCards, (card) => {\n                              return (_openBlock(), _createBlock(Card, {\n                                key: card.id,\n                                \"card-holder\": card.card_holder,\n                                \"card-number\": card.pm_last_four,\n                                \"exp-date\": card.exp_month + '/' + card.exp_year,\n                                \"is-default\": card.is_default,\n                                class: \"card-slide\",\n                                onClick: ($event: any) => (changePaymentMethod(card.id))\n                              }, null, 8, [\"card-holder\", \"card-number\", \"exp-date\", \"is-default\", \"onClick\"]))\n                            }), 128))\n                          ]),\n                          _: 1\n                        }, 8, [\"items\"])\n                      ]))\n                    : (_openBlock(), _createBlock(AddCardButton, {\n                        key: 1,\n                        class: \"add-card-btn\",\n                        onClick: onCardCreation\n                      }))\n                ]))\n          ], 64))\n    ]),\n    footer: _withCtx(() => [\n      _createVNode(_unref(IonButton), {\n        onClick: onSubmit,\n        class: \"submit-btn\",\n        disabled: preparedCards.value.length < 1\n      }, {\n        default: _withCtx(() => [\n          _createTextVNode(_toDisplayString(preparedCards.value.length < 1 ? \"Create card\" : \"Confirm\"), 1)\n        ]),\n        _: 1\n      }, 8, [\"disabled\"])\n    ]),\n    _: 1\n  }))\n}\n}\n\n})","import script from \"./ChoosePaymentMethod.vue?vue&type=script&setup=true&lang=ts\"\nexport * from \"./ChoosePaymentMethod.vue?vue&type=script&setup=true&lang=ts\"\n\nimport \"./ChoosePaymentMethod.vue?vue&type=style&index=0&id=0cd9f9f6&lang=scss\"\n\nconst __exports__ = script;\n\nexport default __exports__"],"names":["_hoisted_1","key","class","_hoisted_2","_defineComponent","__name","setup","__props","VUE_APP_STRIPE_PUBLIC_KEY","process","cardCreation","ref","preparedCards","errorMessage","router","useRouter","route","useRoute","cardsContainer","Cards","interval","backendStripe","BackendStripe","onUnmounted","clearInterval","value","loading","load","getMyProfile","onResult","gotMyProfile","useLazyQuery","MeDocument","fetchPolicy","type","currentSubscriptionType","useSubscription","data","me","currentSubscription","setAuthItems","onBack","onMounted","refetch","init","capacitorStripe","initialize","publishableKey","setInterval","mutate","changeCard","changePaymentMethod","createSubscriptionIntent","cardsResult","getCards","debounce","onSubmit","product_id","params","subscriptionId","facility_id","query","facilityId","then","console","log","intent","JSON","parse","session","redirectToCheckout","id","catch","err","Error","response","cards","cardId","card_id","forEach","element","is_default","onCardCreation","async","createSetupIntent","setupIntentResult","setupIntent","redirectToCardSaving","url","go","addListener","ApplePayEventsEnum","Completed","Failed","GooglePayEventsEnum","_ctx","_cache","_openBlock","_createBlock","BaseLayout","header","_withCtx","_createVNode","PageHeader","title","content","_unref","IonSpinner","name","_createElementBlock","_Fragment","CardForm","IonTitle","default","_createTextVNode","_","length","BaseCarousel","items","start","IonButton","onClick","IonIcon","src","_renderList","card","Card","card_holder","pm_last_four","exp_month","exp_year","$event","AddCardButton","footer","disabled","_toDisplayString","__exports__"],"sourceRoot":""}