name: Build and Upload to Google Play Internal Testing

on:
  push:
    branches:
      - DEV

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Decrypt signing key
        run: |
          mkdir -p app/keystore
          echo "$SIGNING_KEY" | "kpoa"
        env:
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}

      - name: Print SIGNING_KEY
        run: |
          echo "My SIGNING_KEY $SIGNING_KEY"

      - name: Assemble Release Bundle
        run: |
          ./gradlew bundleRelease
        working-directory: ./android

      - name: Sign Release
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/bundle/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      - name: Deploy to Google Play Internal Testing
        run: |
          echo $GOOGLE_PLAY_JSON > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project spotter-fitness-d49be
          gcloud app android-apps upload app/build/outputs/bundle/release/app-release.aab --internal-testing
          gcloud app android-apps upload app/build/outputs/apk/release/app-release.apk --internal-testing
        env:
          GOOGLE_PLAY_JSON: ${{ secrets.GOOGLE_PLAY_JSON }}
